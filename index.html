<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Morozov Ultra</title>
    <style>
        /* Базовые настройки для предотвращения прыжков интерфейса */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        .hidden { display: none !important; }
        
        /* Боковое меню (Drawer) */
        #side-menu { transition: transform 0.3s ease; z-index: 2000; width: 280px; }
        .menu-open { transform: translateX(0) !important; }
        .menu-overlay { background: rgba(0,0,0,0.6); transition: opacity 0.3s; z-index: 1500; }

        /* Стиль сообщений */
        #chat-window { 
            background-color: #e5ddd5; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
        .msg { max-width: 80%; padding: 8px 14px; border-radius: 16px; margin-bottom: 6px; font-size: 15px; position: relative; }
        .msg-mine { background: #effdde; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-their { background: #ffffff; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }

        /* Тёмная тема */
        body.dark-mode { background-color: #0e1621; color: white; }
        .dark-mode #side-menu { background-color: #17212b; color: white; }
        .dark-mode header { background-color: #242f3d !important; }
        .dark-mode #contact-list-screen { background-color: #0e1621; }
        .dark-mode .contact-item { background-color: #17212b; border-bottom: 1px solid #0e1621; color: white; }
        .dark-mode .msg-their { background: #182533; color: white; }
        .dark-mode .msg-mine { background: #2b5278; color: white; }
        .dark-mode #chat-window { background-color: #0e1621; filter: contrast(0.9) brightness(0.8); }
        .dark-mode #input-area { background-color: #17212b; border-top: 1px solid #0e1621; }
        .dark-mode input { background-color: #242f3d; color: white; }
    </style>
</head>
<body class="flex flex-col bg-white transition-colors duration-300">

    <div id="call-overlay" class="fixed inset-0 bg-slate-900 z-[5000] hidden flex flex-col items-center justify-around text-white p-10">
        <div class="text-center">
            <div id="call-avatar" class="w-32 h-32 bg-blue-500 rounded-full mx-auto mb-6 flex items-center justify-center text-5xl font-bold shadow-2xl border-4 border-white/20">?</div>
            <h2 id="call-name" class="text-4xl font-bold mb-2">Контакт</h2>
            <p id="call-status" class="text-blue-400 animate-pulse text-xl">Вызов...</p>
        </div>
        <button onclick="endCall()" class="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center text-4xl shadow-2xl active:scale-95 transition">
            <i class="fas fa-phone-slash rotate-[135deg]"></i>
        </button>
    </div>

    <div id="menu-overlay" class="fixed inset-0 menu-overlay opacity-0 pointer-events-none" onclick="toggleMenu()"></div>
    <div id="side-menu" class="fixed top-0 left-0 h-full bg-white -translate-x-full shadow-2xl flex flex-col">
        <div class="bg-[#517da2] p-8 text-white">
            <div id="u-avatar" class="w-20 h-20 bg-blue-400 rounded-full mb-4 flex items-center justify-center text-3xl font-bold border-2 border-white/20">?</div>
            <div id="u-name" class="font-bold text-xl">Пользователь</div>
            <div id="u-phone" class="text-blue-100 opacity-70">Номер</div>
        </div>
        <div class="flex-1 py-4">
            <button onclick="addNewContact()" class="w-full flex items-center gap-6 px-8 py-4 text-lg active:bg-gray-100"><i class="fas fa-user-plus text-blue-500"></i> Новый контакт</button>
            <button onclick="toggleDark()" class="w-full flex items-center gap-6 px-8 py-4 text-lg active:bg-gray-100"><i class="fas fa-moon text-purple-500"></i> Тёмная тема</button>
            <div class="border-t my-4"></div>
            <button onclick="logout()" class="w-full flex items-center gap-6 px-8 py-4 text-lg text-red-500 active:bg-red-50"><i class="fas fa-sign-out-alt"></i> Выход</button>
        </div>
    </div>

    <header class="bg-[#517da2] h-16 flex items-center justify-between px-4 text-white shadow-lg shrink-0 z-[1000] pt-[env(safe-area-inset-top)]">
        <div class="flex items-center gap-3">
            <button id="m-btn" onclick="toggleMenu()" class="w-10 h-10 flex items-center justify-center text-2xl"><i class="fas fa-bars"></i></button>
            <button id="b-btn" onclick="closeChat()" class="hidden w-10 h-10 flex items-center justify-center text-2xl"><i class="fas fa-arrow-left"></i></button>
            <h1 id="h-title" class="font-bold text-lg">Morozov Chat</h1>
        </div>
        <div id="call-box" class="hidden flex gap-4">
            <button onclick="initCall()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-lg active:bg-white/40"><i class="fas fa-phone-alt"></i></button>
            <button onclick="initCall()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-lg active:bg-white/40"><i class="fas fa-video"></i></button>
        </div>
    </header>

    <div id="contact-list-screen" class="flex-1 overflow-y-auto bg-gray-50">
        <div id="c-list"></div>
    </div>

    <div id="chat-screen" class="hidden fixed inset-0 flex flex-col pt-16 z-[500] bg-white dark:bg-[#0e1621]">
        <div id="chat-window" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>
        <div id="input-area" class="h-16 bg-white border-t flex items-center px-3 gap-2 shrink-0 pb-[env(safe-area-inset-bottom)]">
            <input id="m-input" type="text" onkeydown="if(event.key==='Enter') sendMsg()" class="flex-1 bg-gray-100 h-10 rounded-full px-5 outline-none dark:bg-[#242f3d]" placeholder="Сообщение...">
            <button onclick="sendMsg()" class="w-10 h-10 bg-[#3390ec] text-white rounded-full flex items-center justify-center text-sm shadow-md"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        let user = JSON.parse(localStorage.getItem('wb_profile')) || null;
        let contacts = JSON.parse(localStorage.getItem('wb_contacts')) || [];
        let histories = JSON.parse(localStorage.getItem('wb_histories')) || {};
        let activeId = null;
        let isDark = localStorage.getItem('wb_dark') === 'true';

        // Переменные для звука звонка
        let audioCtx = null;
        let ringInterval = null;

        if(isDark) document.body.classList.add('dark-mode');

        // Проверка входа
        if (!user) {
            const name = prompt("Ваше имя:");
            const phone = prompt("Ваш номер:");
            if(name && phone) {
                user = {name, phone};
                localStorage.setItem('wb_profile', JSON.stringify(user));
                location.reload();
            }
        } else {
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-phone').innerText = user.phone;
            document.getElementById('u-avatar').innerText = user.name[0].toUpperCase();
        }

        // --- ФУНКЦИИ ЗВУКА ---
        function startRinging() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const playTone = () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(425, audioCtx.currentTime);
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.1);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.2);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 1.3);
            };
            playTone();
            ringInterval = setInterval(playTone, 4000);
        }

        function stopRinging() {
            if (ringInterval) { clearInterval(ringInterval); ringInterval = null; }
        }

        // --- УПРАВЛЕНИЕ ---
        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('menu-open');
            document.getElementById('menu-overlay').classList.toggle('opacity-0');
            document.getElementById('menu-overlay').classList.toggle('pointer-events-none');
        }

        function toggleDark() {
            isDark = !isDark;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('wb_dark', isDark);
            toggleMenu();
        }

        function render() {
            const list = document.getElementById('c-list');
            list.innerHTML = "";
            contacts.forEach(c => {
                const div = document.createElement('div');
                div.className = "contact-item p-4 flex items-center gap-4 bg-white border-b active:opacity-60 cursor-pointer";
                div.innerHTML = `<div class="w-14 h-14 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">${c.name[0].toUpperCase()}</div>
                                 <div class="font-bold text-lg">${c.name}</div>`;
                div.onclick = () => openChat(c);
                list.appendChild(div);
            });
        }

        function openChat(c) {
            activeId = c.id;
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('m-btn').classList.add('hidden');
            document.getElementById('b-btn').classList.remove('hidden');
            document.getElementById('call-box').classList.remove('hidden');
            document.getElementById('h-title').innerText = c.name;
            loadHist();
        }

        function closeChat() {
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('m-btn').classList.remove('hidden');
            document.getElementById('b-btn').classList.add('hidden');
            document.getElementById('call-box').classList.add('hidden');
            document.getElementById('h-title').innerText = "WB Chat";
        }

        function sendMsg() {
            const inp = document.getElementById('m-input');
            if(!inp.value.trim()) return;
            const m = {text: inp.value, mine: true};
            if(!histories[activeId]) histories[activeId] = [];
            histories[activeId].push(m);
            localStorage.setItem('wb_histories', JSON.stringify(histories));
            append(m);
            inp.value = "";
        }

        function append(m) {
            const win = document.getElementById('chat-window');
            const d = document.createElement('div');
            d.className = `msg ${m.mine ? 'msg-mine self-end' : 'msg-their self-start'} px-4 py-2 flex flex-col`;
            d.innerHTML = `<span>${m.text}</span>`;
            win.appendChild(d);
            win.scrollTop = win.scrollHeight;
        }

        function loadHist() {
            document.getElementById('chat-window').innerHTML = "";
            (histories[activeId] || []).forEach(append);
        }

        function addNewContact() {
            const n = prompt("Имя нового контакта:");
            if(n) {
                const id = 'id_'+Date.now();
                contacts.push({id, name: n});
                localStorage.setItem('wb_contacts', JSON.stringify(contacts));
                render();
                toggleMenu();
            }
        }

        function initCall() {
            document.getElementById('call-overlay').classList.remove('hidden');
            document.getElementById('call-name').innerText = document.getElementById('h-title').innerText;
            document.getElementById('call-avatar').innerText = document.getElementById('h-title').innerText[0].toUpperCase();
            startRinging();
        }

        function endCall() {
            document.getElementById('call-overlay').classList.add('hidden');
            stopRinging();
        }

        function logout() { localStorage.clear(); location.reload(); }

        render();
    </script>
</body>
</html>





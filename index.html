<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>WB Mobile</title>
    <style>
        :root { --main-blue: #3390ec; }
        .hidden { display: none !important; }
        
        /* –§–æ–Ω –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö */
        #chat-window {
            background-color: #e5ddd5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-attachment: fixed;
        }

        /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
        .mobile-panel { transition: transform 0.3s ease; }
        
        /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        ::-webkit-scrollbar { width: 0; }

        /* –í–∏–¥–µ–æ –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video {
            position: absolute; top: 20px; right: 20px; width: 90px; height: 130px;
            border-radius: 12px; border: 2px solid white; z-index: 1000;
        }
    </style>
</head>
<body class="bg-white h-screen flex flex-col overflow-hidden select-none">

    <div id="login-screen" class="fixed inset-0 bg-white z-[9000] flex flex-col items-center justify-center p-8">
        <div class="w-24 h-24 bg-blue-500 rounded-3xl flex items-center justify-center mb-8 shadow-xl">
            <i class="fas fa-paper-plane text-white text-4xl"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2">WB Messenger</h1>
        <p class="text-gray-400 mb-8 text-center">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä –¥–ª—è –≤—Ö–æ–¥–∞</p>
        <input type="text" id="reg-name" placeholder="–ò–º—è" class="w-full bg-gray-100 p-4 rounded-2xl mb-4 outline-none border-2 border-transparent focus:border-blue-500">
        <input type="tel" id="reg-phone" placeholder="+7 (___) ___-__-__" class="w-full bg-gray-100 p-4 rounded-2xl mb-8 outline-none border-2 border-transparent focus:border-blue-500">
        <button onclick="register()" class="w-full bg-[#3390ec] text-white p-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="call-overlay" class="fixed inset-0 bg-gray-900 z-[8000] hidden flex flex-col">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted class="hidden"></video>
        <div class="absolute inset-0 bg-black/30 flex flex-col items-center justify-between py-20 text-white">
            <div class="text-center">
                <h2 id="call-name" class="text-3xl font-bold mb-2">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="call-status" class="animate-pulse">–í—ã–∑–æ–≤...</p>
            </div>
            <button onclick="endCall()" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-3xl shadow-2xl">
                <i class="fas fa-phone-slash rotate-[135deg]"></i>
            </button>
        </div>
    </div>

    <header class="bg-[#517da2] text-white px-4 py-3 flex justify-between items-center shrink-0 pt-[env(safe-area-inset-top)]">
        <div class="flex items-center gap-3">
            <button id="back-btn" onclick="showList()" class="hidden mr-2"><i class="fas fa-arrow-left"></i></button>
            <span id="header-title" class="font-bold text-xl uppercase tracking-tight">WB Chat</span>
        </div>
        <div id="call-btns" class="hidden flex gap-5">
            <button onclick="initCall('–ê—É–¥–∏–æ')"><i class="fas fa-phone-alt"></i></button>
            <button onclick="initCall('–í–∏–¥–µ–æ')"><i class="fas fa-video"></i></button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <div id="side-panel" class="w-full bg-white absolute inset-0 z-20 overflow-y-auto">
            <div id="contact-list"></div>
            <button onclick="addNewContact()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-500 text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-30">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="chat-panel" class="w-full bg-white absolute inset-0 z-10 flex flex-col translate-x-full mobile-panel">
            <div id="chat-window" class="flex-1 p-4 flex flex-col gap-3 overflow-y-auto"></div>
            
            <div id="input-area" class="p-2 pb-[env(safe-area-inset-bottom)] bg-gray-50 flex items-center gap-2 border-t">
                <button onclick="toggleStickers()" class="w-10 h-10 text-gray-400 text-xl"><i class="far fa-smile"></i></button>
                <input id="msg-input" type="text" onkeydown="if(event.key==='Enter') sendMessage()" class="flex-1 bg-white border p-2 px-4 rounded-full outline-none" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                <button onclick="sendMessage()" class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center"><i class="fas fa-paper-plane text-sm"></i></button>
            </div>

            <div id="sticker-panel" class="hidden h-40 bg-white border-t p-4 flex gap-4 overflow-x-auto">
                <div onclick="sendSticker('üòÇ')" class="text-5xl">üòÇ</div>
                <div onclick="sendSticker('üî•')" class="text-5xl">üî•</div>
                <div onclick="sendSticker('‚ù§Ô∏è')" class="text-5xl">‚ù§Ô∏è</div>
                <div onclick="sendSticker('üëç')" class="text-5xl">üëç</div>
            </div>
        </div>
    </main>

    <nav id="bottom-nav" class="h-16 border-t bg-gray-50 flex justify-around items-center shrink-0 pb-[env(safe-area-inset-bottom)]">
        <button onclick="showList()" class="text-blue-500 flex flex-col items-center gap-1">
            <i class="fas fa-comment"></i>
            <span class="text-[10px] font-bold">–ß–∞—Ç—ã</span>
        </button>
        <button onclick="alert('–°–∫–æ—Ä–æ!')" class="text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-phone"></i>
            <span class="text-[10px] font-bold">–ó–≤–æ–Ω–∫–∏</span>
        </button>
        <button onclick="logout()" class="text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-cog"></i>
            <span class="text-[10px] font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </button>
    </nav>

    <script>
        let user = JSON.parse(localStorage.getItem('wb_profile')) || null;
        let contacts = JSON.parse(localStorage.getItem('wb_contacts')) || [];
        let histories = JSON.parse(localStorage.getItem('wb_histories')) || {};
        let activeId = null;
        let audioCtx = null;
        let ringInterval = null;

        if (user) document.getElementById('login-screen').classList.add('hidden');

        function register() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            if (name && phone) {
                localStorage.setItem('wb_profile', JSON.stringify({name, phone}));
                location.reload();
            }
        }

        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = "";
            contacts.forEach(c => {
                const div = document.createElement('div');
                div.className = "p-4 flex items-center gap-4 border-b active:bg-gray-100 transition";
                div.innerHTML = `<div class="w-14 h-14 rounded-full bg-blue-400 text-white flex items-center justify-center font-bold text-xl">${c.name[0]}</div>
                                 <div class="flex-1">
                                    <div class="font-bold text-lg">${c.name}</div>
                                    <div class="text-sm text-gray-400">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</div>
                                 </div>`;
                div.onclick = () => openChat(c);
                list.appendChild(div);
            });
        }

        function openChat(c) {
            activeId = c.id;
            document.getElementById('chat-panel').style.transform = "translateX(0)";
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('call-btns').classList.remove('hidden');
            document.getElementById('header-title').innerText = c.name;
            document.getElementById('bottom-nav').classList.add('hidden');
            loadHistory();
        }

        function showList() {
            document.getElementById('chat-panel').style.transform = "translateX(100%)";
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('call-btns').classList.add('hidden');
            document.getElementById('header-title').innerText = "WB Chat";
            document.getElementById('bottom-nav').classList.remove('hidden');
        }

        function sendMessage() {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim()) return;
            const msg = { text: inp.value, isMine: true };
            if(!histories[activeId]) histories[activeId] = [];
            histories[activeId].push(msg);
            localStorage.setItem('wb_histories', JSON.stringify(histories));
            appendMsg(msg);
            inp.value = "";
        }

        function appendMsg(m) {
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = m.isMine ? "self-end" : "self-start";
            div.innerHTML = `<div class="${m.isMine ? 'bg-[#effdde]' : 'bg-white'} p-3 px-4 rounded-2xl shadow-sm max-w-[80vw]">${m.text}</div>`;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function loadHistory() {
            document.getElementById('chat-window').innerHTML = "";
            (histories[activeId] || []).forEach(appendMsg);
        }

        function addNewContact() {
            const name = prompt("–ò–º—è:");
            if(name) {
                const id = 'id_' + Date.now();
                contacts.push({id, name});
                localStorage.setItem('wb_contacts', JSON.stringify(contacts));
                renderContacts();
            }
        }

        function logout() { localStorage.clear(); location.reload(); }
        function toggleStickers() { document.getElementById('sticker-panel').classList.toggle('hidden'); }
        function sendSticker(s) { sendMessage({text: s, isMine: true}); toggleStickers(); }

        // –ó–≤—É–∫–∏ –∏ –ó–≤–æ–Ω–∫–∏ (–∫–∞–∫ –≤ –ø—Ä–æ—à–ª—ã—Ö –≤–µ—Ä—Å–∏—è—Ö)
        function initCall(type) {
            document.getElementById('call-overlay').classList.remove('hidden');
            document.getElementById('call-name').innerText = document.getElementById('header-title').innerText;
            // –õ–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–∞...
        }
        function endCall() { document.getElementById('call-overlay').classList.add('hidden'); }

        renderContacts();
    </script>
</body>
</html>
